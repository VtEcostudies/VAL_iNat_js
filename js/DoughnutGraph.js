const data = [{
                    "count": 4431,
                    "taxon": {
                      "observations_count": 54985,
                      "taxon_schemes_count": 6,
                      "is_active": true,
                      "ancestry": "48460/1/2/355675/3/7251/13547/144351",
                      "flag_counts": {
                        "resolved": 0,
                        "unresolved": 0
                      },
                      "wikipedia_url": "http://en.wikipedia.org/wiki/Black-capped_chickadee",
                      "current_synonymous_taxon_ids": null,
                      "iconic_taxon_id": 3,
                      "rank_level": 10,
                      "taxon_changes_count": 1,
                      "atlas_id": null,
                      "complete_species_count": null,
                      "parent_id": 144351,
                      "complete_rank": "subspecies",
                      "name": "Poecile atricapillus",
                      "rank": "species",
                      "extinct": false,
                      "id": 144815,
                      "default_photo": {
                        "id": 5306749,
                        "license_code": "cc-by-nc",
                        "attribution": "(c) Heather Pickard, some rights reserved (CC BY-NC)",
                        "url": "https://inaturalist-open-data.s3.amazonaws.com/photos/5306749/square.jpg",
                        "original_dimensions": {
                          "height": 1639,
                          "width": 2048
                        },
                        "flags": [],
                        "square_url": "https://inaturalist-open-data.s3.amazonaws.com/photos/5306749/square.jpg",
                        "medium_url": "https://inaturalist-open-data.s3.amazonaws.com/photos/5306749/medium.jpg"
                      },
                      "ancestor_ids": [
                        48460,
                        1,
                        2,
                        355675,
                        3,
                        7251,
                        13547,
                        144351,
                        144815
                      ],
                      "iconic_taxon_name": "Aves",
                      "preferred_common_name": "Black-capped Chickadee"
                    }
                  },
                  {
                    "count": 4066,
                    "taxon": {
                      "observations_count": 144272,
                      "taxon_schemes_count": 9,
                      "is_active": true,
                      "ancestry": "48460/1/2/355675/3/7251/15977/12705",
                      "flag_counts": {
                        "resolved": 0,
                        "unresolved": 0
                      },
                      "wikipedia_url": "http://en.wikipedia.org/wiki/American_robin",
                      "current_synonymous_taxon_ids": null,
                      "iconic_taxon_id": 3,
                      "rank_level": 10,
                      "taxon_changes_count": 0,
                      "atlas_id": null,
                      "complete_species_count": null,
                      "parent_id": 12705,
                      "complete_rank": "subspecies",
                      "name": "Turdus migratorius",
                      "rank": "species",
                      "extinct": false,
                      "id": 12727,
                      "default_photo": {
                        "id": 65895239,
                        "license_code": "cc-by-nc-nd",
                        "attribution": "(c) Dennis Church, some rights reserved (CC BY-NC-ND)",
                        "url": "https://static.inaturalist.org/photos/65895239/square.jpg",
                        "original_dimensions": {
                          "height": 1365,
                          "width": 2048
                        },
                        "flags": [],
                        "square_url": "https://static.inaturalist.org/photos/65895239/square.jpg",
                        "medium_url": "https://static.inaturalist.org/photos/65895239/medium.jpg"
                      },
                      "ancestor_ids": [
                        48460,
                        1,
                        2,
                        355675,
                        3,
                        7251,
                        15977,
                        12705,
                        12727
                      ],
                      "iconic_taxon_name": "Aves",
                      "preferred_common_name": "American Robin"
                    }
                  },
                  {
                    "count": 3850,
                    "taxon": {
                      "observations_count": 127314,
                      "taxon_schemes_count": 7,
                      "is_active": true,
                      "ancestry": "48460/1/2/355675/40151/848317/848320/848324/152870/424850/42158/846185/846324/42219",
                      "flag_counts": {
                        "resolved": 3,
                        "unresolved": 0
                      },
                      "wikipedia_url": "http://en.wikipedia.org/wiki/White-tailed_deer",
                      "current_synonymous_taxon_ids": null,
                      "iconic_taxon_id": 40151,
                      "rank_level": 10,
                      "taxon_changes_count": 0,
                      "atlas_id": 4,
                      "complete_species_count": null,
                      "parent_id": 42219,
                      "name": "Odocoileus virginianus",
                      "rank": "species",
                      "extinct": false,
                      "id": 42223,
                      "default_photo": {
                        "id": 14137818,
                        "license_code": "cc-by",
                        "attribution": "(c) moviecoco568, some rights reserved (CC BY)",
                        "url": "https://inaturalist-open-data.s3.amazonaws.com/photos/14137818/square.jpg",
                        "original_dimensions": {
                          "height": 1200,
                          "width": 1920
                        },
                        "flags": [],
                        "square_url": "https://inaturalist-open-data.s3.amazonaws.com/photos/14137818/square.jpg",
                        "medium_url": "https://inaturalist-open-data.s3.amazonaws.com/photos/14137818/medium.jpg"
                      },
                      "ancestor_ids": [
                        48460,
                        1,
                        2,
                        355675,
                        40151,
                        848317,
                        848320,
                        848324,
                        152870,
                        424850,
                        42158,
                        846185,
                        846324,
                        42219,
                        42223
                      ],
                      "iconic_taxon_name": "Mammalia",
                      "preferred_common_name": "White-tailed Deer",
                      "establishment_means": {
                        "establishment_means": "native",
                        "id": 164250,
                        "place": {
                          "id": 47,
                          "name": "Vermont",
                          "display_name": "Vermont, US",
                          "ancestry": "97394/1"
                        }
                      },
                      "preferred_establishment_means": "native"
                    }
                  },
                  {
                    "count": 3752,
                    "taxon": {
                      "observations_count": 189179,
                      "taxon_schemes_count": 6,
                      "is_active": true,
                      "ancestry": "48460/1/47120/372739/47158/184884/47157/47224/47922/61244/134169/522900/48663",
                      "flag_counts": {
                        "resolved": 7,
                        "unresolved": 2
                      },
                      "wikipedia_url": "http://en.wikipedia.org/wiki/Monarch_butterfly",
                      "current_synonymous_taxon_ids": null,
                      "iconic_taxon_id": 47158,
                      "rank_level": 10,
                      "taxon_changes_count": 1,
                      "atlas_id": 1231,
                      "complete_species_count": null,
                      "parent_id": 48663,
                      "name": "Danaus plexippus",
                      "rank": "species",
                      "extinct": false,
                      "id": 48662,
                      "default_photo": {
                        "id": 13824507,
                        "license_code": "cc-by-nc",
                        "attribution": "(c) fam-esquivel, some rights reserved (CC BY-NC)",
                        "url": "https://inaturalist-open-data.s3.amazonaws.com/photos/13824507/square.jpg",
                        "original_dimensions": {
                          "height": 1361,
                          "width": 2048
                        },
                        "flags": [],
                        "square_url": "https://inaturalist-open-data.s3.amazonaws.com/photos/13824507/square.jpg",
                        "medium_url": "https://inaturalist-open-data.s3.amazonaws.com/photos/13824507/medium.jpg"
                      },
                      "ancestor_ids": [
                        48460,
                        1,
                        47120,
                        372739,
                        47158,
                        184884,
                        47157,
                        47224,
                        47922,
                        61244,
                        134169,
                        522900,
                        48663,
                        48662
                      ],
                      "iconic_taxon_name": "Insecta",
                      "preferred_common_name": "Monarch"
                    }
                  },
                  {
                    "count": 3524,
                    "taxon": {
                      "observations_count": 27853,
                      "taxon_schemes_count": 8,
                      "is_active": true,
                      "ancestry": "48460/1/2/355675/20978/26718/27701/787591/27800",
                      "flag_counts": {
                        "resolved": 1,
                        "unresolved": 0
                      },
                      "wikipedia_url": "https://en.wikipedia.org/wiki/Eastern_newt",
                      "current_synonymous_taxon_ids": null,
                      "iconic_taxon_id": 20978,
                      "rank_level": 10,
                      "taxon_changes_count": 0,
                      "atlas_id": 229,
                      "complete_species_count": null,
                      "parent_id": 27800,
                      "name": "Notophthalmus viridescens",
                      "rank": "species",
                      "extinct": false,
                      "id": 27805,
                      "default_photo": {
                        "id": 48283767,
                        "license_code": null,
                        "attribution": "(c) mattbuckingham, all rights reserved",
                        "url": "https://static.inaturalist.org/photos/48283767/square.jpg",
                        "original_dimensions": {
                          "height": 732,
                          "width": 1024
                        },
                        "flags": [],
                        "square_url": "https://static.inaturalist.org/photos/48283767/square.jpg",
                        "medium_url": "https://static.inaturalist.org/photos/48283767/medium.jpg"
                      },
                      "ancestor_ids": [
                        48460,
                        1,
                        2,
                        355675,
                        20978,
                        26718,
                        27701,
                        787591,
                        27800,
                        27805
                      ],
                      "iconic_taxon_name": "Amphibia",
                      "preferred_common_name": "Eastern Newt",
                      "establishment_means": {
                        "establishment_means": "native",
                        "id": 109249,
                        "place": {
                          "id": 47,
                          "name": "Vermont",
                          "display_name": "Vermont, US",
                          "ancestry": "97394/1"
                        }
                      },
                      "preferred_establishment_means": "native"
                    }
                  },
                  {
                    "count": 3126,
                    "taxon": {
                      "observations_count": 50327,
                      "taxon_schemes_count": 7,
                      "is_active": true,
                      "ancestry": "48460/47126/211194/136329/47375/47562/47561/790730/790765",
                      "flag_counts": {
                        "resolved": 0,
                        "unresolved": 0
                      },
                      "wikipedia_url": "http://en.wikipedia.org/wiki/Pinus_strobus",
                      "current_synonymous_taxon_ids": null,
                      "iconic_taxon_id": 47126,
                      "rank_level": 10,
                      "taxon_changes_count": 3,
                      "atlas_id": 13993,
                      "complete_species_count": null,
                      "parent_id": 790765,
                      "name": "Pinus strobus",
                      "rank": "species",
                      "extinct": false,
                      "id": 52391,
                      "default_photo": {
                        "id": 4583,
                        "license_code": "cc-by-nc-nd",
                        "attribution": "(c) copepodo, some rights reserved (CC BY-NC-ND)",
                        "url": "https://inaturalist-open-data.s3.amazonaws.com/photos/4583/square.jpg",
                        "original_dimensions": {
                          "height": 1536,
                          "width": 2048
                        },
                        "flags": [],
                        "square_url": "https://inaturalist-open-data.s3.amazonaws.com/photos/4583/square.jpg",
                        "medium_url": "https://inaturalist-open-data.s3.amazonaws.com/photos/4583/medium.jpg"
                      },
                      "ancestor_ids": [
                        48460,
                        47126,
                        211194,
                        136329,
                        47375,
                        47562,
                        47561,
                        790730,
                        790765,
                        52391
                      ],
                      "iconic_taxon_name": "Plantae",
                      "preferred_common_name": "eastern white pine",
                      "establishment_means": {
                        "establishment_means": "native",
                        "id": 88548,
                        "place": {
                          "id": 47,
                          "name": "Vermont",
                          "display_name": "Vermont, US",
                          "ancestry": "97394/1"
                        }
                      },
                      "preferred_establishment_means": "native"
                    }
                  },
                  {
                    "count": 2959,
                    "taxon": {
                      "observations_count": 76566,
                      "taxon_schemes_count": 9,
                      "is_active": true,
                      "ancestry": "48460/1/2/355675/3/7251/7823/7998",
                      "flag_counts": {
                        "resolved": 1,
                        "unresolved": 0
                      },
                      "wikipedia_url": "http://en.wikipedia.org/wiki/American_crow",
                      "current_synonymous_taxon_ids": null,
                      "iconic_taxon_id": 3,
                      "rank_level": 10,
                      "taxon_changes_count": 0,
                      "atlas_id": null,
                      "complete_species_count": null,
                      "parent_id": 7998,
                      "complete_rank": "subspecies",
                      "name": "Corvus brachyrhynchos",
                      "rank": "species",
                      "extinct": false,
                      "id": 8021,
                      "default_photo": {
                        "id": 24115,
                        "license_code": "cc-by-nc",
                        "attribution": "(c) Joe McKenna, some rights reserved (CC BY-NC)",
                        "url": "https://inaturalist-open-data.s3.amazonaws.com/photos/24115/square.jpg",
                        "original_dimensions": {
                          "height": 1448,
                          "width": 2048
                        },
                        "flags": [],
                        "square_url": "https://inaturalist-open-data.s3.amazonaws.com/photos/24115/square.jpg",
                        "medium_url": "https://inaturalist-open-data.s3.amazonaws.com/photos/24115/medium.jpg"
                      },
                      "ancestor_ids": [
                        48460,
                        1,
                        2,
                        355675,
                        3,
                        7251,
                        7823,
                        7998,
                        8021
                      ],
                      "iconic_taxon_name": "Aves",
                      "preferred_common_name": "American Crow"
                    }
                  },
                  {
                    "count": 2844,
                    "taxon": {
                      "observations_count": 89677,
                      "taxon_schemes_count": 9,
                      "is_active": true,
                      "ancestry": "48460/1/2/355675/3/7251/559248/9091",
                      "flag_counts": {
                        "resolved": 0,
                        "unresolved": 0
                      },
                      "wikipedia_url": "http://en.wikipedia.org/wiki/Song_sparrow",
                      "current_synonymous_taxon_ids": null,
                      "iconic_taxon_id": 3,
                      "rank_level": 10,
                      "taxon_changes_count": 0,
                      "atlas_id": null,
                      "complete_species_count": null,
                      "parent_id": 9091,
                      "complete_rank": "subspecies",
                      "name": "Melospiza melodia",
                      "rank": "species",
                      "extinct": false,
                      "id": 9100,
                      "default_photo": {
                        "id": 168805729,
                        "license_code": "cc-by-sa",
                        "attribution": "(c) Cephas, some rights reserved (CC BY-SA)",
                        "url": "https://inaturalist-open-data.s3.amazonaws.com/photos/168805729/square.jpg",
                        "original_dimensions": {
                          "height": 1365,
                          "width": 2048
                        },
                        "flags": [],
                        "square_url": "https://inaturalist-open-data.s3.amazonaws.com/photos/168805729/square.jpg",
                        "medium_url": "https://inaturalist-open-data.s3.amazonaws.com/photos/168805729/medium.jpg"
                      },
                      "ancestor_ids": [
                        48460,
                        1,
                        2,
                        355675,
                        3,
                        7251,
                        559248,
                        9091,
                        9100
                      ],
                      "iconic_taxon_name": "Aves",
                      "preferred_common_name": "Song Sparrow"
                    }
                  },
                  {
                    "count": 2827,
                    "taxon": {
                      "observations_count": 43242,
                      "taxon_schemes_count": 4,
                      "is_active": true,
                      "ancestry": "48460/47126/211194/47125/47124/47853/47852/49203",
                      "flag_counts": {
                        "resolved": 1,
                        "unresolved": 0
                      },
                      "wikipedia_url": "http://en.wikipedia.org/wiki/Fagus_grandifolia",
                      "current_synonymous_taxon_ids": null,
                      "iconic_taxon_id": 47126,
                      "rank_level": 10,
                      "taxon_changes_count": 0,
                      "atlas_id": null,
                      "complete_species_count": null,
                      "parent_id": 49203,
                      "name": "Fagus grandifolia",
                      "rank": "species",
                      "extinct": false,
                      "id": 49202,
                      "default_photo": {
                        "id": 9216901,
                        "license_code": "cc-by-nc",
                        "attribution": "(c) Sara Rall, some rights reserved (CC BY-NC)",
                        "url": "https://inaturalist-open-data.s3.amazonaws.com/photos/9216901/square.jpeg",
                        "original_dimensions": {
                          "height": 1361,
                          "width": 2048
                        },
                        "flags": [],
                        "square_url": "https://inaturalist-open-data.s3.amazonaws.com/photos/9216901/square.jpeg",
                        "medium_url": "https://inaturalist-open-data.s3.amazonaws.com/photos/9216901/medium.jpeg"
                      },
                      "ancestor_ids": [
                        48460,
                        47126,
                        211194,
                        47125,
                        47124,
                        47853,
                        47852,
                        49203,
                        49202
                      ],
                      "iconic_taxon_name": "Plantae",
                      "preferred_common_name": "American beech",
                      "establishment_means": {
                        "establishment_means": "native",
                        "id": 94121,
                        "place": {
                          "id": 47,
                          "name": "Vermont",
                          "display_name": "Vermont, US",
                          "ancestry": "97394/1"
                        }
                      },
                      "preferred_establishment_means": "native"
                    }
                  }]


/* Summarize the output form the API into something usable */

const newData = data.map(obs => {
                      const container = {};
                      container[obs.taxon.preferred_common_name] = obs.count;
                      return container;
                  })
console.log(newData);

//console.log(Object.keys(preparedData));
function createDoughnutGraph({dataJson,
                              type="Species_Counts",
                              htmlID=null,
                              lineColor="steelblue",
                              lineWidth=1.5,
                              width = 450,
                              height = 450,
                              margin = 70,
                              spaceSides = 460,
                              spaceTopBot = 460}) {

if(htmlID===null){console.log(`createDoughnutGraph needs htmlID`)}
// NEED TO ADD A SWITCH HERE on type for key words
var newData = dataJson.map(obs => {
                        const container = {};
                        container[obs.taxon.preferred_common_name] = obs.count;
                        return container;})

console.log(Object.getOwnPropertyNames(newData));


/* collapses the array of objects into a single object */
//https://stackoverflow.com/questions/27538349/merge-multiple-objects-inside-the-same-array-into-one-object/27538363
var preparedData = newData.reduce(function(result, current) {
                                 return Object.assign(result, current);}, {});

/* simple function to get sum */
function add(accumulator, a) {return accumulator + a;}

/* derive the number of observations in the data */
var totalObs = Object.values(preparedData).reduce(add,0);

console.log(`total obs: ${totalObs}`)

// The radius of the pieplot is half the width or half the height (smallest one). I subtract a bit of margin.
var radius = Math.min(width, height) / 2 - margin;

// append the svg object to the div called 'my_dataviz'
var svg = d3.select("#" + htmlID)
  .append("svg")
    .attr("width", width)
    .attr("height", height)
  .append("g")
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

// set the color scale
var color = d3.scaleOrdinal()
  //.domain(["a", "b", "c", "d", "e", "f", "g", "h"])
  .domain(Object.keys(preparedData))
  .range(d3.schemeDark2);

console.log(`colors: ${color}`);
// Compute the position of each group on the pie:
var pie = d3.pie()
  .sort(null) // Do not sort group by size
  .value(function(d) {return d.value; })
var data_ready = pie(d3.entries(preparedData))

// change the key to species names
data_ready.key = data.species

// The arc generator
var arc = d3.arc()
  .innerRadius(radius * 0.7)         // This is the size of the donut hole
  .outerRadius(radius * 0.8)

// Another arc that won't be drawn. Just for labels positioning
var outerArc = d3.arc()
  .innerRadius(radius * 0.9)
  .outerRadius(radius * 0.9)

// Build the pie chart: Basically, each part of the pie is a path that we build using the arc function.
svg
  .selectAll('allSlices')
  .data(data_ready)
  .enter()
  .append('path')
  .attr('d', arc)
  .attr('fill', function(d){ return(color(d.data.key)) })
  .attr("stroke", "white")
  .style("stroke-width", "2px")
  .style("opacity", 0.7)

/* add text to center of the donut plot */
    svg.append("text")
       .attr("text-anchor", "middle")
       .attr('font-size', '4em')
       .attr('y', 20)
       .text(totalObs.toLocaleString());

/* add text to center of the donut plot */
    svg.append("text")
        .attr("text-anchor", "middle")
        .attr('font-size', '2em')
        .attr('y', -40)
        .text(`Observations:`);

// Add one dot in the legend for each name.
svg.selectAll("mydots")
  .data(data_ready)
  .enter()
  .append("circle")
    .attr("cx", -10)
    .attr("cy", function(d,i){ return 130 + i*12}) // 100 is where the first dot appears. 25 is the distance between dots
    .attr("r", 5)
    .style("fill", function(d){ return color(d.data.key)})

// Add one dot in the legend for each name.
svg.selectAll("mylabels")
  .data(data_ready)
  .enter()
  .append("text")
    .attr("x", -8)
    .attr("y", function(d,i){ return 130 + i*12}) // 100 is where the first dot appears. 25 is the distance between dots
    .style("fill", function(d){ return color(d.data.key)})
    .text(function(d){ return d.data.key})
    .attr("text-anchor", "left")
    .style("alignment-baseline", "middle")

}

createDoughnutGraph({dataJson: data,
                     htmlID: "doughnutSppObs"})
